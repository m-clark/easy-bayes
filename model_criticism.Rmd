# (PART\*) Part IV: Model Criticism {-}

# Model Criticism in rstanarm and brms

- Much of the core functionality is the same across both packages
- Functions that exist in both are identical
- We will focus on brms, which has some extras

# Model Exploration

## Linear models

For linear models, one might be interested in some notion of $R^2$

Automatically get an interval estimate as well

```{r brms_R2, eval=TRUE}
fit <- brm(mpg ~ wt + cyl, data = mtcars, refresh = 0)
bayes_R2(fit, digits=2)
```

Mixed models can include random effects or not

```{r brms_R2_mixed, eval=TRUE}
bayes_R2(sleepstudy_brms, re_formula = NA)
```

```{r brms_R2_mixed_with_re, eval=TRUE}
bayes_R2(sleepstudy_brms)
```



## Marginal effects


<span class="pack">brms</span> allows one to to plot marginal effects

For standard linear models this is useful for group comparisons and interactions

For nonlinear models (glm and beyond) useful for any effect

```{r brms_marginal, eval=TRUE}
marginal_effects(attendance_brms)
```


## Hypothesis tests

Null hypothesis testing doesn't apply to the Bayesian context

However, we can still ask questions about the probability of certain outcomes

```{r brms_hype, eval=TRUE}
attendance_brms

hypothesis(attendance_brms, 'genderMale < -.2')

hypothesis(attendance_brms, 'progGeneral/progAcademic > 1')
```


## Extracting results

If there is something specific you need to do with the results, it is easy to get access to the output

```{r brms_extract}
posterior_samples(attendance_brms, pars = 'math') %>% head()

posterior_samples(attendance_brms, pars = 'math') %>% 
  qplot(data=., x = b_math, geom = 'density')
```



# Model Diagnostics

Numerous model diagnostics are available to the Bayesian analyst


The Stan ecosystem makes exploring these not only easy, but fun!

## Shiny stan

<span class="pack">shinystan</span> allows for interactive exploration of model diagnostics

Just use <span class="func">launch_shinystan</span> on any model object from <span class="pack">rstan</span>, <span class="pack">rstanarm</span>, or <span class="pack">brms</span>

```{r shinystan}
launch_shinystan(attendance_brms)
```


## pp check

Posterior predictive checks can let us inspect what the model suggests for our target variable vs. what actually is the case

```{r pp_check, eval=TRUE}
pp_check(attendance_brms)
```

The Poisson's underlying assumption of the mean equaling the variance rarely holds with typical data. One way to handle overdispersion in count models is to move to something like negative binomial or other approaches.  Interestingly, for Poisson models we can have a random effect per observation (even in the non-Bayesian context)[^pln].  In this case, our pp_check suggests a much better result.

```{r pp_check2_init}
attendance_brms_add_re = update(attendance_brms, . ~ . + (1|id), 
                                newdata = attendance)
pp_check(attendance_brms_add_re)
```

```{r pp_check2, echo=FALSE, eval=TRUE}
attendance_brms_add_re = update(attendance_brms, . ~ . + (1|id), newdata = attendance, refresh=0)
pp_check(attendance_brms_add_re)
```

For more on this see [Ben Bolker's demonstration with lme4](https://glmm.wdfiles.com/local--files/examples/overdispersion.pdf).





## loo plot

We can get into observation level diagnostics as well

While the process is very technical, we can use the simple visualization to note 'outliers'

Look for values above .7 (though this default can be changed)

```{r loo_plot, eval=TRUE}
plot(loo(attendance_brms))
title('')
```

# Model Performance
## Model Comparison

```{r WAIC}
WAIC(attendance_brms, attendance_brms_add_re)
```

## model average

```{r}
pp_average(attendance_brms, attendance_brms_add_re)
```


## prediction




[^pln]: This essentially changes the model to incorporate a Poisson log-normal distribution.  As @montesinos-lopez_bayesian_2017 describe:
> The Poisson component of the Poisson-lognormal distribution accommodates integer inputs (or outputs) to describe the actual number of counts observed within a single unit or sample, while the lognormal component of the distribution describes the overdispersion in the Poisson rate parameter...

<!-- https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5427491/ -->